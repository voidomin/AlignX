<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mustang Analysis Report - {{ date }}</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- jQuery and Bootstrap JS loaded early to support inline interactive scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />

    <!-- 3Dmol JS: Embedded or CDN Fallback -->
    {% if dmol_js %}
    <script>
      {
        {
          dmol_js | safe;
        }
      }
    </script>
    {% else %}
    <script src="https://3dmol.org/build/3Dmol-min.js"></script>
    {% endif %}

    <style>
      :root {
        --primary-color: #ff7e42; /* Sunset Orange */
        --secondary-color: #ffb343; /* Mustard Glow */
        --accent-cyan: #42eaff;
        --bg-dark: #0f1115;
        --card-bg: #181b21;
        --text-color: #ffffff;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg-dark);
        color: var(--text-color);
        padding-bottom: 50px;
      }
      .navbar {
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .navbar-brand {
        font-weight: 800;
        background: linear-gradient(135deg, #ff0080, #7b1fa2, #00e5ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-size: 1.5rem;
      }
      .section-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }
      h2 {
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 10px;
        margin-bottom: 20px;
        color: #fff;
      }
      .metric-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 15px;
        text-align: center;
      }
      .metric-value {
        font-size: clamp(1.2rem, 5vw, 1.8rem);
        font-weight: bold;
        color: var(--secondary-color);
        word-break: break-all;
        line-height: 1.2;
      }
      .metric-label {
        font-size: 0.9rem;
        opacity: 0.8;
      }
      .insight-box {
        background: rgba(0, 229, 255, 0.1);
        border-left: 4px solid var(--secondary-color);
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 4px;
      }
      table {
        color: var(--text-color) !important;
      }
      .table-dark {
        --bs-table-bg: var(--card-bg);
        --bs-table-striped-bg: rgba(255, 255, 255, 0.05);
      }
      .viewer_3d {
        height: 500px;
        width: 100%;
        position: relative;
        background-color: #000;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg fixed-top">
      <div class="container">
        <a class="navbar-brand" href="#">ðŸ§¬ AlignX Lab Notebook</a>
        <span class="text-muted">{{ date }}</span>
      </div>
    </nav>

    <div class="container" style="margin-top: 80px">
      <!-- Header -->
      <div class="text-center mb-5">
        <h1 class="display-4 fw-bold">Analysis Report</h1>
        <p class="lead text-muted">Generated by Mustang Pipeline v2.1</p>
      </div>

      <!-- 1. Key Metrics -->
      <div class="section-card">
        <h2>ðŸ“Š Alignment Statistics</h2>
        <div class="row">
          <div class="col-md-3">
            <div class="metric-card">
              <div class="metric-value">{{ stats.num_structures }}</div>
              <div class="metric-label">Structures Aligned</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="metric-card">
              <div class="metric-value">{{ stats.chain_length }}</div>
              <div class="metric-label">Alignment Length</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="metric-card">
              <div class="metric-value">{{ stats.mean_rmsd }} Ã…</div>
              <div class="metric-label">Mean RMSD</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="metric-card">
              <div class="metric-value">{{ stats.identity }}%</div>
              <div class="metric-label">Seq Identity</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 2. Automated Insights -->
      {% if insights %}
      <div class="section-card">
        <h2>ðŸ§  Smart Insights</h2>
        {% for insight in insights %}
        <div class="insight-box">{{ insight | safe }}</div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- 3. 3D Structure Viewer -->
      {% if pdb_content %}
      <div class="section-card">
        <h2>ðŸ§¬ 3D Structure Alignment</h2>
        <p class="text-muted">
          Interactive 3D view of the superimposed structures (Cartoon
          representation).
        </p>
        <div id="container-01" class="viewer_3d"></div>
        <script>
          $(function () {
            let element = $("#container-01");
            let config = { backgroundColor: "black" };
            let viewer = $3Dmol.createViewer(element, config);
            // Using template literal for multiline string, escaping backticks is crucial
            let pdbData = `{{ pdb_content }}`;
            viewer.addModel(pdbData, "pdb"); /* load data */
            viewer.setStyle(
              {},
              { cartoon: { color: "spectrum" } },
            ); /* style all atoms */
            viewer.zoomTo(); /* set camera */
            viewer.render(); /* render scene */
            viewer.zoom(1.2, 1000); /* slight zoom out animation */
          });
        </script>
      </div>
      {% endif %}

      <!-- 4. RMSD Heatmap -->
      <div class="section-card">
        <h2>ðŸ”¥ RMSD Heatmap</h2>
        <p class="text-muted">Pairwise all-vs-all structural comparison.</p>
        <div id="heatmap-plot">{{ heatmap_div | safe }}</div>
      </div>

      <!-- 5. RMSF Plot -->
      {% if rmsf_div %}
      <div class="section-card">
        <h2>ðŸŒŠ Residue Flexibility (RMSF)</h2>
        <p class="text-muted">Structural fluctuation per residue position.</p>
        <div id="rmsf-plot">{{ rmsf_div | safe }}</div>
      </div>
      {% endif %}

      <!-- 6. Ligands -->
      {% if ligand_summary %}
      <div class="section-card">
        <h2>ðŸ’Š Ligand Summary</h2>
        <p>Ligands identified in the analyzed structures.</p>
        {{ ligand_summary | safe }}
      </div>
      {% endif %}

      <footer class="text-center mt-5 text-muted">
        <p>
          <small>Generated with Mustang Pipeline v2.1 &bull; {{ date }}</small>
        </p>
      </footer>
    </div>

    <!-- Scripts moved to head for better compatibility with inline initialization -->
  </body>
</html>
